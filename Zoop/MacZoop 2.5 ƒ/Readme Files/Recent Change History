MacZoop 2.5 detailed change history2.5 FinalgIsAColourMac no longer exists - extern reference to it removedconditional compilation of code for Navigation, appearance, etc now doesn't additionally check TARGET_API_MAC_CARBON - since that setting forces the others ON, the code can be tidied upZApplication::RunApplication name changed to DoMacZoopBirth.Cleaned up global space. ZObject debugging globals changed to static data members. Inspector updated to suit. Numerous global static colours moved into global space for greater utility. Many superfluous globals removed or changed to static members where appropriate. All static class members now adopt modern naming convention of sName... rather than fName... or gName... ZWindowManager callbacks changed to static methods and drag control variables changed to static members from globals.Cleaned up identifier names so that all constants are enumerated rather than #defined, and all macros have upper-case identifiers. A handful of exceptions to this remain for compatibility with older code.TEGetStyleRunInfo finally fixed so that it takes into account the null style record. This ommission/bug has been there since this code was created. Note that this actually now shows up a bug in TextEdit when the insertion point is at the beginning of the text, but there is no doubt that Apple will never fix this, sadly. There may be a workaround available at some point. ZTextView altered so that the menus are enabled even if the selection is an insertion point.Number of maximum fonts and sizes that can be returned by TEGetStyleRunInfo reduced from 99 to 31. This is in an effort to improve memory use - it seems most unlikely that this many will be exceeded.ZTextView::SetFontInfo rewritten to be correct for styled text. This method will now set the font used for the entire text.Window dragging now vectored through ZWindow::DoWindowDrag method so that dragging may be overridden individually by the window. A drag limit rectangle can now be passed in to ZWindowManager::DragWindowOutline - if NULL, this uses the desktop bounds as before.Fixed bug in Carbon version of window manager class - IsDialog was not working correctly and in fact removing it altogether fixes the problem. Similarly, Activate, Deactivate and DeactivateForDialog methods removed - original code is fine in Carbon. Also fixed a bug where window menu would not always work in Carbon version.All old VBL-based cursor handling code now removed completely in favour of Time Manager based code. 68K version of this code improved to use safer assembly glue.Timings of animated cursors altered to make them closer to the tick-based equivalents that used to be handled by VBL callbacks. This results in a slightly faster beachball, the watch is the same. If you have animated cursors of your own, you may find they will go somewhat faster - if this is unacceptable, revise the "period" parameter to suit.Themed cursors are now supported transparently - if a themed cursor is available for one of the existing cursor constants, it will work automatically. If you want to use an explicit theme cursor, just pass the NEGATIVE of the theme cursor ID to SetCursorShape.PalMDEF.c renamed to PalMDEF.cpp  - needed to compile with MPW. Tear-off menu support code removed (has not been supported since version 2.1)Fixed new bug in ZControlView where it was ignoring the settings in an attached local environment.Added flag to ZView to switch whether updates are generated by activate events. This is normally ON, but the ability to turn it off gives you a useful flicker-reduction tool for some view types that do not need to redraw in such a case (i.e. a view that does not have a different appearance according to the active state). The only one at the moment is ZGWorldView, which now clears this flag.Added $$DITL magic item. This is potentially a very powerful feature. It allows you to pull in a complete DITL resource into a dialog from another DITL. This process can continue to any degree of complexity, so you can build up complex hierarchies of dialog items, and share complete UI layouts between different dialogs easily. It adds just a couple of lines of code to MacZoop, yet opens up a huge vista of possibilities. Cool, I call it ;-)Added inspector support to ZTooltipHandler.Interaction between selection and drag/drop behaviour in ZArrayBrowser improved - dragging into a list with a selection removes the selection. Dropping items into a list sets the selection to the dropped items. It makes it much clearer what's going on and is probably a more intuitive behaviour. ZArrayBrowser also now sets the drag cursor when necessary.Basic drag and drop ability added to ZEditFieldView. The selection can be dragged off if kEFAllowDragSend is set, and text can be dragged in if kEFAllowDragReceive is set. Dropped text replaces the entire field content - this reflects the common usage - there is no textview-like caret positioning happening. Dragging to self is not supported.Enhanced ZEventhandler and ZWindow to implement the ability to have keyboard input directed to a floater. This works by creating a temporary "spring loaded" input mode when an item in a floater such as an edit field is clicked in. Typing and tabbing will then work within that floater as normal. Typing return, enter or escape, or activating or clicking in any window will release the mode, refocussing whatever was focussed before the mode was entered. This allows you finally to use a floater  as a place to enter data, which for some interface designs can be useful. In general this should not be deployed willy-nilly, but at least now it's there if you really want it.Edit field now sets refresh on resize flag in case people are creating resizeable edit fields.Virtually all source files updated to the new function header comment style. This should make it easier to quickly determine what a method is for since most have better descriptions than before.Added MPW make files supplied by Tom Hopper to the SDK. Tom has kindly agreed to provide a Read Me file for this, and will answer any related queries via the MacZoop discussion list.Carbon-based printing turned on and tested. This requires CarbonLib 1.1 or later. Apps built against CarbonLib 1.0.4 will not be able to print (you'll get link errors anyway), though of course classic print manager works on non-Carbon OS anyway.Classic printing no longer supports a progress bar, so PRINT_USING_PROGRESS_BAR is ignored. This setting caused problems with some print drivers; drivers often handle their own progress dialogs while printing anyway. This setting was never implemented on Carbon.Fixed bug with setting zoom source rect from a pushbutton - needed to refocus the view.Fixed bug with redrawing in ZHexEditView. This class also now supports drag and drop by default.Factored code in ZApplication so that extracting a list of files to open or print from an AEDescList is handled by a couple of new methods - OpenFiles and PrintFiles. This allows the result obtained from Navigation to be handled by the same code. This allows us to permit multiple selections in the Open dialog. This is handled by a new method - OpenMultiple, and there's a new standard command to create an Open More... menu item (77). This feature requires Navigation Services. Apps could also decide to call this for standard Open if they wish in their own versions of ZApplication.ZScrollAwareView now overrides SetAutoSizing so that its parent is set when a sizing value is passed to it. This allows compound items in dialogs to have their sizing set correctly from ILIM resource, etc.Added 'ISIZ' resource type to get around limitations of ILIM type. Modified ZViewDialog to use the new type if available (uses old one if not). This change allows future developments with dialog views to have some headroom. In addition, the resource format is much easier to set up manually, because each field is separate. Recommended instead of ILIM mechanism.Implement right and centre font alignment in ZEditFieldView. If using these options, view will not autoscroll due to bug in TextEdit. YHBW.Increased number of magic parameters permissable in new dialogs from 10 to 16 at a user's request. Old dialogs still impose a limit of 10.Implemented a special message in ZScrollView for when it changes size. This is intended to inform views embedded within that they may wish to consider taking this into account. ZArrayBrowser uses this message to move the rightmost column position to match the edge of the scrollview or its former value, whichever was larger. This allows the last column to expand to fill the available space which looks better in some situations.Added long rowbytes support to ZGWorld.Windows now correctly deactivate under Carbon when a print dialog is displayed.ZViewDialog no longer overwrites a control's value or title with the empty string for a magic item that consists only of the four letter code and nothing else. This makes it feasible to preset some types of view string content in the creator function and not have this subsequently overwritten by the dialog.Implemented creator functions for version strings, both MacZoop version and application version in 'vers' resource. These are just special creators for ZTextBoxView, and are registered as a standard item.ZFileSpecViewer now condenses and truncates size string to fit cell if necessary.Tooltips will now be forced onscreen if they need to be. This is multiple-monitor aware. Factored code in ZWindow to facilitate this - GetMaxMonitor method returns best monitor for a window.Implemented a scroll throttle in ZScrollView to prevent scrolling going too fast. It is off by default, though a call to AutoScroll temporarily turns it on to make this action more controllable on fast hardware.Demo now includes ZGraphWindow and ZExpParser in Carbon build - not sure why this wasn't there before, but anyway it definitely works.Implemented JPEG file opening in Demo app. This uses a file helper and a ZGWorldView to show that you don't need to subclass ZWindow at all for this simple sort of thing nowadays.f4ZWindow now disables the font menu when it is closed, in case one of the views within it previously enabled it. This is needed because ZTextView does not receive a deactivate message at Close time any more.Further minor changes to allow MPW compilation. (Thanks, Tom!)ZHexEditView changes the text drawing mode to workaround a minor cosmetic bug where the vertical scroll delimiter line was getting partially erased. This bug appears to be a bug in DrawString with srcCopy mode being off by one with the clip region, but I haven't investigated it fully.Cosmetic fix to non-appearance version of ZTabSelectorView.For your convenience, the inspector now additionally decodes reported long and unsigned long values as four-char code sequences, since this is what they very often are. List header column positions set to match changes to list view in f3. Inspector list view optimised to only draw what's visible so is now a lot faster when there are many objects.kParViewRecalcBounds kludge message deleted; ZScrollView no longer implements ReceiveMessage to action this message - all scroll bounds settings must be done normally or through ZScrollAwareView. This message was originally added before ZScrollAwareView existed - it is no longer required.Made minor changes as necessary to allow compilation with __OBJECT_DEBUG switched off. The demo altered so that if this is the case, the Inspector menu command is not enabled (since the inspector is just blank when app compiled in this state).Modified ZControlView again so that it really plays along with the irritating and lame appearance manager under OS X- OK, you win, I store a true control rect and always set the origin to 0,0. This makes it inefficient to use controls in a scrolling view, but hey, complain to Apple, not me, they wrote this shit. I've worked around this problem by recalculating the control rect every single time it is focused. Controls still don't always draw properly when used in an Aqua tab pane, because that is mucking around with the patterns itself on OS X, even though now MacZoop is playing by the rules absolutely. Fix sought.Implemented tooltip support for views. This involves a small helper class, ZTooltipHandler, plus enhancements to ZView, ZApplication and ZEventHandler. To obtain tooltip support, add #define __TOOLTIPS ON to your ProjectSettings.h file, and add MZTooltips.cpp to the project. Added new standard command (76) to toggle tooltips on or off. Note that if you are using tooltips with Carbon, you must use UH 3.4 or later, and CarbonLib 1.1 or later. (If not you'll get a warning at compile time and an exception at runtime if you attempt to make a tooltip window). Tooltips are not available with CarbonLib1.0.4, though they work with the classic InterfaceLib for PPC and 68KEnhanced ZViewDialog to set up dialog item tooltips from DTIP resource with same ID as the DITL. Added templates for this resource to MacZoop.¹.rsrc. Added general purpose utility function GetIndStringFromResource to do low-level string extraction that this code is based on.Added flippant tooltips for most of the dialogs in the demo, and added Tooltips command toWindows menu.Fixed bug in TimerTimer - one-shot timers could fire prematurely if they were the only timer in the queue, because the global ticks were not updated if the queue was empty, therefore as soon as the timer was added, the previous value of ticks would be checked, sometimes found to be older than the interval, and the timer would fire. Now TimerTimer updates its global copy of TickCount and milliseconds even when the queue is empty.Fixed shift-selection bug in ZArrayBrowser - line calculation was not always correct depending on the line height - smaller lineheights worked improperly.Beta history removed to another document to release space in this file.ZControlView now uses appearance (GetControlRegion) to determine how much extra space to allow around a control - this is necessary with Aqua and possibly other themes. It uses this to determine the true clipping region to use when drawing controls.Updated code so it compiles with UH 3.4 (CarbonLib 1.2). Added some definitions to Compatibility.h so that if you're usingan earlier version of the headers, it should still compile OK. (Mainly this involves changes to New...xxx...UPP functions).Updated a variety of classes (ZFolderScanner, CursorUtilities) to use newer UPP style proc pointers rather than older ...Proc APIs. Also corrected function prototypes to what is now defined in the Universal Headers. If you get problems compiling this, make sure you are using at least version 3.3 of UH, and preferably 3.4.Carbon scrap manager class altered so that it ignores spurious out of memory errors. This is caused by a known problem when using the CodeWarrior debugger. This should not happen, bug has been reported to Apple.When compiling for Carbon, MacZoop.h makes sure that APPEARANCE_MGR_AWARE is always true and that appearance.h is always included. Carbon builds are therefore inherently appearance aware and the setting in ProjectSettings.h is ignored. This is also the case for USE_MODERN_WINDOW_MGR, USE_PROXY_ICONS, USE_PROPORTIONAL_SCROLLBARS, _USE_NAVIGATION_SERVICES and _USE_NAV_SAVEREVERT_ALERTS. This means that Carbon builds ALWAYS gain these particular feaures whatever you set in your settings.ZArrayBrowser now obscures the cursor if the user types into it.Added delta parameters to ZScrollView::ScrollHook - should make it easier to perform auxiliary scrolling operations without flicker since you can easily make calls to ScrollRect here.ZProgress now remembers where it was placed on screen and restores it next time (if a prefs file created).Fixed ZDialog so it compiles with newer view environment stuff. This doesn't yet mean it is guaranteed to work properly though - these classes are very much in low-maintenance mode.Pattern and colour pop-up views improved to avoid double-redraws. Reinstated colourised 1-bit pattern option in pattern pop-up.Bug fixed where resizable flag was not being set for resizable dialogs in 68K (non-appearance) builds. (Thnx, Koen!)ZViewDialog now overrides SetSize such that if a modeless border frame is drawn, it is correctly erased and redrawn when the dialog is resized.Numerous classes and routines made const correct.Fixed bug with non-appearance live scrolling in ZScrollView. No longer crashes on 68K systems.Changed static globals for scrolling callbacks to static members of ZScrollView. This is both more "correct" and makes it a simpler matter to override the live scrolling in a subclass should you wish to. (Thanks to Jeff for this suggestion!)Added accessor to ZScrollView to get width used for the scrollbars.Renamed resource files containing the '¹' character (MacZoop.proj.rsrc and ZoopDev.proj.rsrc). This prevents a bad character in the XML export of the project. Sadly this will mean you have to update your projects to accommodate the filename change.Changed global growzone callbacks in ZApplication into static members. Changed some methods to be const correct - including MakeNewWindowType so you will almost certainly need to update any application subclass to match otherwise your method will not be called. Removed a number of modifier calls from ZApplication - this mechanism will gradually be deprecated across the board in favour of new explicit helper objects and registries.Added window registry mechanism to ZApplication. This is an alternative to the need to override MakeNewWindowType or to set up window types in ProjectSettings.h. Instead, you can simply register a 'WindowCreationProc' with ZApplication and it will call that proc when it gets a request to open the associated file type. This avoids the need to subclass ZApplication if you're only doing it to create window types of various kinds. The creation modifier support has been deleted to make way for this mecahnism, so if you were relying on it, you will need to make a revision to your code to use the new mechanism. The other traditional techniques are still fully supported however.ZApplication now queries process manager for application name in GetName method rather than using low memory global.RunApplication main entry point method is now a static member of ZApplication rather than a global.Global functions relating to the drag and drop callbacks in ZWindow changed to be static members of ZWindow. Oh I just love cleaning up my globals!Added SysBeep call to save changes alert when this is handled by Navigation Services.Add ZMenuBarView class - this may yet need some more work to make it really usable. (Work in progress)Added ZFileHelper class definition and code to ZWindow to use this. This feature allows you to hand off the actual opening and saving of a file to the helper object. Now we have views, this can often be used to avoid the need to subclass ZWindow at all, though code that does so will work unchanged.Edit field validation logic now ensures that the root window is selected and updated if need be before displaying the alert. This makes it clearer which field is in contention even if the window was previously hidden or behind another.Added Macro AVG to ZDefines.h (computes average of two arguments). Also CENTRE and CENTER are synonyms for this.Rolled in Max's latest version of ZTextView which features undoable typing and commands - it's great! (Thanks, Max!)It is now possible to set the number of undo levels that each window initially receives automatically, rather than have to set each individually. This is handled by ZApplication. You can programmatically set it using gApplication->SetDefaultUndoLevels( n ) or you can set the number in your ProjectSettings.h file using the define: NUMBER_OF_INITIAL_UNDO_LEVELS. Every window that is created using MakeNewWindowType will have its undo stack initially set to this number. If a particular window wants something else, you can set it in the usual way.Graham CoxMarch 1st, 2001