/****************************************************************************************************			MacZoop - "the framework for the rest of us"		 ****			BottleneckFix.c		-- workaround for Appearance + SetOrigin problem******			©2000, Graham Cox*****************************************************************************************************/#include	"BottleneckFix.h"#include	"GrafMacros.h"#include	"ZDefines.h"#include	"Compatibility.h"#include	<MacMemory.h>// functions to install and handle erase ops in windows - needed to workaround ugly bugs in Aqua etc, which are// caused by Appearance not doing the right thingstatic CQDProcsPtr		gUBFixProcs = NULL;void	InstallBottleneckFix( WindowPtr aWindow ){	if ( gUBFixProcs == NULL )	{		gUBFixProcs = (CQDProcsPtr) NewPtr( sizeof( CQDProcs ));		SetStdCProcs( gUBFixProcs );			// replace procs with those of ours that handle erase. Note these casts are needed to allow		// our const correct code to be compiled with headers 3.3.2 which is not const correct.				gUBFixProcs->rectProc 	= NewQDRectUPP((QDRectProcPtr) MZBugRect );		gUBFixProcs->rRectProc 	= NewQDRRectUPP((QDRRectProcPtr) MZBugRRect );		gUBFixProcs->ovalProc 	= NewQDOvalUPP((QDOvalProcPtr) MZBugOval );		gUBFixProcs->rgnProc 	= NewQDRgnUPP((QDRgnProcPtr) MZBugRgn );	}#if TARGET_API_MAC_CARBON	SetPortGrafProcs( GetWindowPort( aWindow ), gUBFixProcs );#else	((CGrafPtr) aWindow )->grafProcs = gUBFixProcs;#endif}pascal void		MZBugRect( GrafVerb verb, const Rect *r ){	Rect 		nr = *r;	short		oh, ov;	RgnHandle	clip;	GrafPtr		port;		if ( verb == kQDGrafVerbErase )	{		GetPort( &port );		oh = PORTPORTRECT( port )->left;		ov = PORTPORTRECT( port )->top;		SetOrigin( 0, 0 );				// offset nr to compensate. Since TextEdit uses some bizarre rects		// close to the edge of QD's space, need to do this manually to avoid overflow.				nr.top    = MAX( nr.top - ov, -32767 );		nr.left   = MAX( nr.left - oh, -32767 );		nr.bottom = MIN( nr.bottom - ov, 32767 );		nr.right  = MIN( nr.right - oh, 32767 );		GetClip( clip = NewRgn());		OffsetRgn( clip, -oh, -ov );		SetClip( clip );			}		StdRect( verb, &nr );		if ( verb == kQDGrafVerbErase )	{		SetOrigin( oh, ov );		OffsetRgn( clip, oh, ov );		SetClip( clip );		DisposeRgn( clip );	}}pascal void		MZBugRRect( GrafVerb verb, const Rect *r, short ovalWidth, short ovalHeight ){	Rect 		nr = *r;	short		oh, ov;	RgnHandle	clip;	GrafPtr		port;		if ( verb == kQDGrafVerbErase )	{		GetPort( &port );		oh = PORTPORTRECT( port )->left;		ov = PORTPORTRECT( port )->top;		SetOrigin( 0, 0 );		OffsetRect( &nr, -oh, -ov );		GetClip( clip = NewRgn());		OffsetRgn( clip, -oh, -ov );		SetClip( clip );			}		StdRRect( verb, &nr, ovalWidth, ovalHeight );		if ( verb == kQDGrafVerbErase )	{		SetOrigin( oh, ov );		OffsetRgn( clip, oh, ov );		SetClip( clip );		DisposeRgn( clip );	}}pascal void		MZBugOval( GrafVerb verb, const Rect *r ){	Rect 		nr = *r;	short		oh, ov;	RgnHandle	clip;	GrafPtr		port;		if ( verb == kQDGrafVerbErase )	{		GetPort( &port );		oh = PORTPORTRECT( port )->left;		ov = PORTPORTRECT( port )->top;		SetOrigin( 0, 0 );		OffsetRect( &nr, -oh, -ov );		GetClip( clip = NewRgn());		OffsetRgn( clip, -oh, -ov );		SetClip( clip );			}		StdOval( verb, &nr );		if ( verb == kQDGrafVerbErase )	{		SetOrigin( oh, ov );		OffsetRgn( clip, oh, ov );		SetClip( clip );		DisposeRgn( clip );	}}pascal void		MZBugRgn( GrafVerb verb, RgnHandle rgn ){	short		oh, ov;	RgnHandle	clip;	GrafPtr		port;		if ( verb == kQDGrafVerbErase )	{		GetPort( &port );		oh = PORTPORTRECT( port )->left;		ov = PORTPORTRECT( port )->top;		SetOrigin( 0, 0 );		OffsetRgn( rgn, -oh, -ov );		GetClip( clip = NewRgn());		OffsetRgn( clip, -oh, -ov );		SetClip( clip );			}			StdRgn( verb, rgn );		if ( verb == kQDGrafVerbErase )	{		SetOrigin( oh, ov );		OffsetRgn( rgn, oh, ov );		OffsetRgn( clip, oh, ov );		SetClip( clip );		DisposeRgn( clip );	}}